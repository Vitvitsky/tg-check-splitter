# Telegram Mini App Migration Plan

> ะะธะณัะฐัะธั check-splitter ะฑะพัะฐ ะธะท ัะธััะพ-ะฑะพัะพะฒะพะณะพ ะธะฝัะตััะตะนัะฐ (inline keyboards + FSM) ะฒ Telegram Mini App ั ะฒะตะฑ-ะธะฝัะตััะตะนัะพะผ.

## ะะพัะธะฒะฐัะธั

### ะัะพะฑะปะตะผั ัะตะบััะตะณะพ UI ะฝะฐ inline-ะบะฝะพะฟะบะฐั
- ะะฐะณะธะฝะฐัะธั (8 ะฟะพะทะธัะธะน ะฝะฐ ัััะฐะฝะธัั) โ ะฝะตัะดะพะฑะฝะพ ะฟัะธ 20+ ะฟะพะทะธัะธัั
- ะะตั ะฒะธะทัะฐะปัะฝะพะณะพ ะฟัะพะณัะตััะฐ: ะบัะพ ััะพ ะฒัะฑัะฐะป, ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
- ะะตะดะฐะบัะธัะพะฒะฐะฝะธะต ะฟะพะทะธัะธะน ัะตัะตะท FSM-ะดะธะฐะปะพะณ (ะธะผั - ัะตะฝะฐ) โ ะผะฝะพะณะพัะฐะณะพะฒะพะต ะธ ะปะพะผะบะพะต
- Inline-ะบะฝะพะฟะบะธ ะฝะต ะฟะพะดะดะตัะถะธะฒะฐัั drag & drop, ัะฒะฐะนะฟั, ะฐะฝะธะผะฐัะธะธ
- ะะตะปัะทั ะพะดะฝะพะฒัะตะผะตะฝะฝะพ ะฒะธะดะตัั ัะฒะพะน ะฒัะฑะพั ะธ ะธัะพะณ

### ะงัะพ ะดะฐัั Mini App
- ะะพะปะฝะพัะตะฝะฝัะน SPA: ะฒัะต ะฟะพะทะธัะธะธ ะฒะธะดะฝั ััะฐะทั, ัะบัะพะปะป ะฒะผะตััะพ ะฟะฐะณะธะฝะฐัะธะธ
- Real-time ะพะฑะฝะพะฒะปะตะฝะธั ัะตัะตะท WebSocket (ะบัะพ ััะพ ะพัะผะตัะฐะตั โ ะฒะธะดะฝะพ ะผะณะฝะพะฒะตะฝะฝะพ)
- ะะฐัะธะฒะฝะพะต ัะตะดะฐะบัะธัะพะฒะฐะฝะธะต: inline-edit, ัะฒะฐะนะฟ ะดะปั ัะดะฐะปะตะฝะธั
- ะะธะทัะฐะปัะฝะฐั ัะฒะพะดะบะฐ: ะบัะพ ะฟะพะดัะฒะตัะดะธะป, ะบัะพ ะฝะตั, ะฟัะพะณัะตัั-ะฑะฐั
- ะคะพัะพ ัะตะบะฐ ะผะพะถะฝะพ ะฟะพะบะฐะทะฐัั ััะดะพะผ ั ะฟะพะทะธัะธัะผะธ
- ะฃะดะพะฑะฝัะน ะฒัะฑะพั ัะฐะตะฒัั ัะตัะตะท slider ะฒะผะตััะพ preset-ะบะฝะพะฟะพะบ
- ะัััะฐั ะฝะฐะฒะธะณะฐัะธั ะผะตะถะดั ัะบัะฐะฝะฐะผะธ (tabs, swipe)

---

## ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ     Telegram Mini App (SPA)    โ  โ React + Vite + @telegram-apps/sdk-react
โ                                โ
โ  ะญะบัะฐะฝั:                       โ
โ  1. ะะปะฐะฒะฝะฐั (ัะตััะธะธ)           โ
โ  2. ะคะพัะพ + OCR                 โ
โ  3. ะะตะดะฐะบัะธัะพะฒะฐะฝะธะต ะฟะพะทะธัะธะน     โ
โ  4. ะะพะปะพัะพะฒะฐะฝะธะต                โ
โ  5. ะงะฐะตะฒัะต + ะธัะพะณ              โ
โ  6. ะคะธะฝะฐะปัะฝัะน ัะฐัััั           โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโ
             โ HTTPS + WebSocket
โโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโ
โ     FastAPI Backend (ะฝะพะฒัะน)     โ  โ API-ัะปะพะน ะฟะพะฒะตัั ัััะตััะฒัััะธั ัะตัะฒะธัะพะฒ
โ                                 โ
โ  REST:                          โ
โ  POST /api/sessions             โ  โ ัะพะทะดะฐัั ัะตััะธั
โ  GET  /api/sessions/{code}      โ  โ ะดะฐะฝะฝัะต ัะตััะธะธ ะฟะพ invite_code
โ  POST /api/sessions/{id}/join   โ  โ ะฟัะธัะพะตะดะธะฝะธัััั
โ  POST /api/sessions/{id}/photos โ  โ ะทะฐะณััะทะธัั ัะพัะพ ัะตะบะฐ
โ  POST /api/sessions/{id}/ocr    โ  โ ะทะฐะฟัััะธัั OCR
โ  PUT  /api/sessions/{id}/items  โ  โ ัะตะดะฐะบัะธัะพะฒะฐัั ะฟะพะทะธัะธะธ
โ  POST /api/sessions/{id}/vote   โ  โ ะฟัะพะณะพะปะพัะพะฒะฐัั
โ  POST /api/sessions/{id}/tip    โ  โ ะฒัะฑัะฐัั ัะฐะตะฒัะต
โ  POST /api/sessions/{id}/confirmโ  โ ะฟะพะดัะฒะตัะดะธัั ะฒัะฑะพั
โ  POST /api/sessions/{id}/finish โ  โ ะทะฐะฒะตััะธัั ะณะพะปะพัะพะฒะฐะฝะธะต
โ  POST /api/sessions/{id}/settle โ  โ ัะฐัััั
โ  GET  /api/sessions/{id}/shares โ  โ ัะตะบััะธะต ะดะพะปะธ
โ  GET  /api/quota                โ  โ ะบะฒะพัะฐ ะฟะพะปัะทะพะฒะฐัะตะปั
โ                                 โ
โ  WebSocket:                     โ
โ  /ws/{session_id}               โ  โ real-time: votes, joins, confirms
โ                                 โ
โ  Auth:                          โ
โ  initData HMAC validation       โ  โ Telegram WebApp auth
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโ
             โ
โโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโ
โ  ะกััะตััะฒัััะธะต ัะตัะฒะธัั (as-is)  โ  โ ะฟะตัะตะธัะฟะพะปัะทัะตะผ ะฑะตะท ะธะทะผะตะฝะตะฝะธะน
โ                                โ
โ  SessionService                โ
โ  OcrService                    โ
โ  CalculatorService             โ
โ  QuotaService                  โ
โ  Models / DB / Alembic         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             +
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  aiogram bot (ััะตะทะฐะฝะฝัะน)       โ  โ ะพััะฐัััั ะดะปั:
โ                                โ
โ  1. /start โ ะพัะบััะฒะฐะตั         โ     Mini App ัะตัะตะท WebAppInfo
โ  2. Deep link โ redirect ะฒ     โ     Mini App ั invite_code
โ  3. Push-ัะฒะตะดะพะผะปะตะฝะธั           โ     (ะธัะพะณะธ, ะฝะพะฒัะต ััะฐััะฝะธะบะธ)
โ  4. Telegram Stars ะพะฟะปะฐัะฐ      โ     (ะฟะพะบะฐ ะฝะตั Stars API ะฒ Mini App)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ะงัะพ ะฟะตัะตะธัะฟะพะปัะทัะตะผ ะฑะตะท ะธะทะผะตะฝะตะฝะธะน

| ะะพะผะฟะพะฝะตะฝั | ะคะฐะนะป | ะะพัะตะผั ัะฐะฑะพัะฐะตั as-is |
|-----------|------|----------------------|
| SessionService | `bot/services/session.py` | ะงะธัััะน async, ะฟัะธะฝะธะผะฐะตั `AsyncSession`, ะฝะต ะทะฐะฒะธัะธั ะพั aiogram |
| OcrService | `bot/services/ocr.py` | ะัะธะฝะธะผะฐะตั `list[bytes]`, ะฒะพะทะฒัะฐัะฐะตั `OcrResult` โ transport-agnostic |
| CalculatorService | `bot/services/calculator.py` | ะงะธัััะต ััะฝะบัะธะธ: `calculate_shares()`, `calculate_user_share()` |
| QuotaService | `bot/services/quota.py` | Async, ะทะฐะฒะธัะธั ัะพะปัะบะพ ะพั SQLAlchemy |
| Models | `bot/models/` | SQLAlchemy ORM โ ัะฐะฑะพัะฐะตั ั ะปัะฑัะผ web framework |
| DB setup | `bot/db.py` | Lazy engine/session โ ะฟะพะดะบะปััะฐะตััั ะบ ัะพะน ะถะต Postgres |
| Alembic | `alembic/` | ะะธะณัะฐัะธะธ ะฝะต ะทะฐะฒะธััั ะพั runtime |
| ะขะตััั | `tests/` | ะขะตััะธัััั ัะตัะฒะธัั, ะฝะต ััะฝะดะปะตัั |

---

## Tech Stack ะดะปั Mini App

### Frontend
- **React 19** + **TypeScript**
- **Vite** โ ัะฑะพัะบะฐ ะธ dev-server
- **@telegram-apps/sdk-react** โ Telegram WebApp SDK (initData, theme, haptics, back button)
- **TanStack Query** โ ัะตัะฒะตัะฝัะน ััะตะนั, ะบััะธัะพะฒะฐะฝะธะต, real-time updates
- **Tailwind CSS 4** โ ััะธะปะธะทะฐัะธั (Telegram theme variables ัะตัะตะท CSS custom properties)
- ะะตั ััะถัะปัั UI-ะฑะธะฑะปะธะพัะตะบ โ ะบะฐััะพะผะฝัะต ะบะพะผะฟะพะฝะตะฝัั ะฟะพะด Telegram design language

### Backend
- **FastAPI** โ API-ััะตะนะผะฒะพัะบ (ัะพั ะถะต async Python, ะตััะตััะฒะตะฝะฝะฐั ะธะฝัะตะณัะฐัะธั ั ัััะตััะฒัััะธะผะธ ัะตัะฒะธัะฐะผะธ)
- **uvicorn** โ ASGI-ัะตัะฒะตั
- **python-multipart** โ ะทะฐะณััะทะบะฐ ัะพัะพ
- **websockets** (ะฒัััะพะตะฝะพ ะฒ FastAPI) โ real-time
- ะะฒัะพัะธะทะฐัะธั ัะตัะตะท **HMAC-SHA256 ะฒะฐะปะธะดะฐัะธั initData**

### ะะฝััะฐััััะบัััะฐ
- **Frontend**: ััะฐัะธะบะฐ ะฝะฐ Vercel / Cloudflare Pages (ะฑะตัะฟะปะฐัะฝะพ, CDN, HTTPS)
- **Backend**: ัะพั ะถะต ัะตัะฒะตั ััะพ ะธ ะฑะพั (ะธะปะธ ะพัะดะตะปัะฝัะน ะบะพะฝัะตะนะฝะตั ะฒ docker-compose)
- **Postgres**: ัะฐ ะถะต ะะ, ัะต ะถะต ะผะธะณัะฐัะธะธ

---

## ะกััะฐัะตะณะธั ะผะธะณัะฐัะธะธ: ะฟะพััะฐะฟะฝะฐั

ะะพั ะธ Mini App ัะฐะฑะพัะฐัั ะฟะฐัะฐะปะปะตะปัะฝะพ. ะะฐะถะดัะน ััะฐะฟ โ ัะฐะผะพะดะพััะฐัะพัะฝัะน ะธะฝะบัะตะผะตะฝั.

---

### ะญัะฐะฟ 1: Backend API + Auth (ััะฝะดะฐะผะตะฝั)

**ะฆะตะปั:** FastAPI ัะตัะฒะตั ั REST API, ะฐะฒัะพัะธะทะฐัะธั ัะตัะตะท Telegram initData.

**ะะพะฒัะต ัะฐะนะปั:**
```
api/
โโโ __init__.py
โโโ __main__.py          # uvicorn entrypoint
โโโ app.py               # FastAPI app factory
โโโ auth.py              # initData HMAC validation + dependency
โโโ deps.py              # DB session dependency (AsyncSession)
โโโ routes/
โ   โโโ __init__.py
โ   โโโ sessions.py      # CRUD ัะตััะธะน
โ   โโโ voting.py        # ะณะพะปะพัะพะฒะฐะฝะธะต
โ   โโโ ocr.py           # ะทะฐะณััะทะบะฐ ัะพัะพ + OCR
โ   โโโ quota.py         # ะบะฒะพัะฐ
โโโ schemas.py           # Pydantic response/request models
```

**ะะฐะดะฐัะธ:**

1. **FastAPI app + config** (`api/app.py`)
   - CORS ะดะปั Mini App ะดะพะผะตะฝะฐ
   - Lifespan: init DB engine
   - Mount static (ะตัะปะธ ะฝัะถะฝะพ)

2. **Auth middleware** (`api/auth.py`)
   - ะะฐััะธะฝะณ `initData` ะธะท ะทะฐะณะพะปะพะฒะบะฐ `Authorization: tma <initData>`
   - HMAC-SHA256 ะฒะฐะปะธะดะฐัะธั: `HMAC_SHA256(HMAC_SHA256(bot_token, "WebAppData"), data_check_string)`
   - ะัะพะฒะตัะบะฐ `auth_date` (ะฝะต ััะฐััะต 24ั)
   - FastAPI Dependency: `get_current_user() -> TelegramUser`

3. **DB dependency** (`api/deps.py`)
   - ะะตัะตะธัะฟะพะปัะทัะตั `get_async_session()` ะธะท `bot/db.py`
   - `async def get_db() -> AsyncGenerator[AsyncSession]`

4. **Pydantic schemas** (`api/schemas.py`)
   - Request/Response ะผะพะดะตะปะธ ะดะปั ะฒัะตั ัะฝะดะฟะพะธะฝัะพะฒ
   - `SessionOut`, `ItemOut`, `VoteIn`, `ShareOut`, `OcrResultOut` ะธ ั.ะด.

5. **Session routes** (`api/routes/sessions.py`)
   - `POST /api/sessions` โ `SessionService.create_session()`
   - `GET /api/sessions/{invite_code}` โ `SessionService.get_session_by_invite()`
   - `POST /api/sessions/{id}/join` โ `SessionService.join_session()`
   - `GET /api/sessions/{id}` โ ะฟะพะปะฝัะต ะดะฐะฝะฝัะต ัะตััะธะธ ั items, members, votes
   - `POST /api/sessions/{id}/finish` โ `SessionService.update_status("closed")`
   - `POST /api/sessions/{id}/settle` โ `calculate_shares()` + update status

6. **Voting routes** (`api/routes/voting.py`)
   - `POST /api/sessions/{id}/vote` โ `SessionService.cycle_vote()`
   - `POST /api/sessions/{id}/tip` โ `SessionService.set_member_tip()`
   - `POST /api/sessions/{id}/confirm` โ `SessionService.confirm_member()`
   - `GET /api/sessions/{id}/shares` โ `calculate_shares()` / `calculate_user_share()`

7. **OCR routes** (`api/routes/ocr.py`)
   - `POST /api/sessions/{id}/photos` โ ะทะฐะณััะทะบะฐ ัะฐะนะปะพะฒ, `SessionService.add_photo()`
   - `POST /api/sessions/{id}/ocr` โ `OcrService.parse_receipt()`
   - `PUT /api/sessions/{id}/items` โ CRUD ะฟะพะทะธัะธะน
   - `DELETE /api/sessions/{id}/items/{item_id}` โ ัะดะฐะปะธัั ะฟะพะทะธัะธั

8. **Quota routes** (`api/routes/quota.py`)
   - `GET /api/quota` โ `QuotaService.get_quota_info()`

9. **ะขะตััั API** (`tests/test_api/`)
   - ะคะธะบััััะฐ: `TestClient` ั ะผะพะบ-initData
   - ะขะตััั ะดะปั auth, sessions, voting, OCR

**ะะฐะฒะธัะธะผะพััะธ (pyproject.toml):**
```toml
"fastapi>=0.115,<1",
"uvicorn[standard]>=0.34,<1",
"python-multipart>=0.0.20,<1",
```

**ะะตะทัะปััะฐั:** ะะฐะฑะพัะฐััะธะน API, ะบะพัะพััะน ะผะพะถะฝะพ ัะตััะธัะพะฒะฐัั ัะตัะตะท curl/httpie.

---

### ะญัะฐะฟ 2: WebSocket ะดะปั real-time

**ะฆะตะปั:** ะฃัะฐััะฝะธะบะธ ะฒะธะดัั ะธะทะผะตะฝะตะฝะธั ะผะณะฝะพะฒะตะฝะฝะพ (ะณะพะปะพัะฐ, ะฟะพะดัะฒะตัะถะดะตะฝะธั, ะฝะพะฒัะต ััะฐััะฝะธะบะธ).

**ะคะฐะนะปั:**
```
api/
โโโ ws.py                # WebSocket manager
โโโ routes/
    โโโ ws.py            # WebSocket endpoint
```

**ะะฐะดะฐัะธ:**

1. **ConnectionManager** (`api/ws.py`)
   - ะััะฟะฟะธัะพะฒะบะฐ ะฟะพ `session_id`
   - `connect(session_id, websocket)`, `disconnect(...)`, `broadcast(session_id, event)`
   - Heartbeat (ping/pong)

2. **WebSocket endpoint** (`api/routes/ws.py`)
   - `WS /ws/{session_id}?token=<initData>`
   - Auth ัะตัะตะท query param (WebSocket ะฝะต ะฟะพะดะดะตัะถะธะฒะฐะตั ะทะฐะณะพะปะพะฒะบะธ)
   - Events (server โ client):
     ```json
     {"type": "vote_updated", "item_id": "...", "user_id": 123, "quantity": 2}
     {"type": "member_joined", "user_id": 123, "name": "Alice"}
     {"type": "member_confirmed", "user_id": 123}
     {"type": "tip_changed", "user_id": 123, "tip_percent": 10}
     {"type": "session_status", "status": "closed"}
     {"type": "items_updated", "items": [...]}
     ```

3. **ะะฝัะตะณัะฐัะธั ั REST routes:**
   - ะะฐะถะดัะน ะผััะธััััะธะน endpoint (vote, confirm, tip, join) ะฟะพัะปะต ะทะฐะฟะธัะธ ะฒ ะะ ะฒัะทัะฒะฐะตั `manager.broadcast()`
   - Broadcast ะธะดัั ะฒัะตะผ ะฟะพะดะบะปัััะฝะฝัะผ ะบ ััะพะน ัะตััะธะธ

**ะะตะทัะปััะฐั:** ะัะบััะป Mini App โ ะฟะพะดะบะปััะธะปัั ะบ WS โ ะฒะธะดะธัั ะฒัะต ะธะทะผะตะฝะตะฝะธั live.

---

### ะญัะฐะฟ 3: Frontend โ ัะบะตะปะตั ะธ ะฝะฐะฒะธะณะฐัะธั

**ะฆะตะปั:** SPA ั ัะพััะธะฝะณะพะผ, Telegram SDK ะธะฝัะตะณัะฐัะธั, ะฑะฐะทะพะฒัะต ัะบัะฐะฝั.

**ะกัััะบัััะฐ:**
```
webapp/
โโโ index.html
โโโ package.json
โโโ vite.config.ts
โโโ tsconfig.json
โโโ tailwind.config.ts
โโโ src/
โ   โโโ main.tsx              # React entry + TelegramProvider
โ   โโโ App.tsx               # Router
โ   โโโ api/
โ   โ   โโโ client.ts         # fetch wrapper ั initData auth
โ   โ   โโโ queries.ts        # TanStack Query hooks
โ   โ   โโโ ws.ts             # WebSocket client hook
โ   โโโ pages/
โ   โ   โโโ HomePage.tsx      # ะะพะธ ัะตััะธะธ + "ะะพะฒัะน ัะตะบ"
โ   โ   โโโ ScanPage.tsx      # ะคะพัะพ + OCR
โ   โ   โโโ EditItemsPage.tsx # ะะตะดะฐะบัะธัะพะฒะฐะฝะธะต ะฟะพะทะธัะธะน
โ   โ   โโโ VotingPage.tsx    # ะัะฑะพั ะฑะปัะด
โ   โ   โโโ TipPage.tsx       # ะงะฐะตะฒัะต + ัะฒะพะดะบะฐ
โ   โ   โโโ SettlePage.tsx    # ะคะธะฝะฐะปัะฝัะน ัะฐัััั
โ   โ   โโโ JoinPage.tsx      # ะัะธัะพะตะดะธะฝะตะฝะธะต ะฟะพ invite_code
โ   โโโ components/
โ   โ   โโโ ItemCard.tsx      # ะะฐััะพัะบะฐ ะฟะพะทะธัะธะธ (ะณะพะปะพัะพะฒะฐะฝะธะต)
โ   โ   โโโ MemberAvatar.tsx  # ะะฒะฐัะฐั ััะฐััะฝะธะบะฐ
โ   โ   โโโ TipSlider.tsx     # ะกะปะฐะนะดะตั ัะฐะตะฒัั
โ   โ   โโโ ShareCard.tsx     # ะะฐััะพัะบะฐ ะดะพะปะธ
โ   โ   โโโ ProgressBar.tsx   # ะัะพะณัะตัั ะฟะพะดัะฒะตัะถะดะตะฝะธะน
โ   โ   โโโ QRCode.tsx        # QR-ะบะพะด ะดะปั invite
โ   โโโ hooks/
โ   โ   โโโ useSession.ts     # ะะฐะณััะทะบะฐ/ะพะฑะฝะพะฒะปะตะฝะธะต ัะตััะธะธ
โ   โ   โโโ useWebSocket.ts   # WS ะฟะพะดะบะปััะตะฝะธะต + events
โ   โ   โโโ useTelegram.ts    # Telegram SDK ัะตะปะฟะตัั
โ   โโโ lib/
โ       โโโ theme.ts          # Telegram theme โ CSS variables
โ       โโโ format.ts         # ะคะพัะผะฐัะธัะพะฒะฐะฝะธะต ัะตะฝ/ะฒะฐะปัั
```

**ะะฐะดะฐัะธ:**

1. **ะะฝะธัะธะฐะปะธะทะฐัะธั ะฟัะพะตะบัะฐ**
   - `npm create vite@latest webapp -- --template react-ts`
   - Tailwind CSS 4, TanStack Query, @telegram-apps/sdk-react
   - Vite proxy ะดะปั dev (`/api` โ `localhost:8000`)

2. **Telegram SDK integration** (`src/main.tsx`)
   - `<TelegramProvider>` โ ะธะฝะธัะธะฐะปะธะทะฐัะธั WebApp
   - Theme sync: ะผะฐะฟะฟะธะฝะณ Telegram CSS vars ะฝะฐ Tailwind
   - Back button handler
   - Haptic feedback ะฝะฐ ะดะตะนััะฒะธัั
   - `MainButton` ะดะปั ะบะปััะตะฒัั CTA

3. **API client** (`src/api/client.ts`)
   - `fetchWithAuth(url, options)` โ ะดะพะฑะฐะฒะปัะตั `Authorization: tma <initData>`
   - ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ (401, 403, 500)
   - Base URL ะธะท env

4. **TanStack Query hooks** (`src/api/queries.ts`)
   - `useSession(code)` โ ะดะฐะฝะฝัะต ัะตััะธะธ
   - `useVoteMutation()` โ ะณะพะปะพัะพะฒะฐะฝะธะต (optimistic update)
   - `useConfirmMutation()` โ ะฟะพะดัะฒะตัะถะดะตะฝะธะต
   - `useTipMutation()` โ ัะฐะตะฒัะต
   - `useShares(sessionId)` โ ัะตะบััะธะต ะดะพะปะธ
   - `useQuota()` โ ะบะฒะพัะฐ

5. **WebSocket hook** (`src/api/ws.ts`, `src/hooks/useWebSocket.ts`)
   - Auto-reconnect ั backoff
   - Invalidate TanStack Query ะฟัะธ ะฟะพะปััะตะฝะธะธ events
   - Typed events: `VoteUpdated | MemberJoined | MemberConfirmed | ...`

6. **ะะพััะธะฝะณ** (`src/App.tsx`)
   - `/` โ HomePage (ัะฟะธัะพะบ ัะตััะธะน)
   - `/scan` โ ScanPage
   - `/session/:code` โ JoinPage โ VotingPage
   - `/session/:code/edit` โ EditItemsPage
   - `/session/:code/vote` โ VotingPage
   - `/session/:code/tip` โ TipPage
   - `/session/:code/settle` โ SettlePage

**ะะตะทัะปััะฐั:** ะะฐะฑะพัะฐััะธะน ะบะฐัะบะฐั SPA ั ะฝะฐะฒะธะณะฐัะธะตะน, ะฐะฒัะพัะธะทะฐัะธะตะน, real-time ะฟะพะดะบะปััะตะฝะธะตะผ.

---

### ะญัะฐะฟ 4: Frontend โ ัะบัะฐะฝั

**ะฆะตะปั:** ะะตะฐะปะธะทะฐัะธั ะฒัะตั ัะบัะฐะฝะพะฒ ะฟัะธะปะพะถะตะฝะธั.

#### 4.1 HomePage โ ะะปะฐะฒะฝะฐั
- ะะฝะพะฟะบะฐ "๐ธ ะะพะฒัะน ัะตะบ" โ ะฟะตัะตัะพะด ะฝะฐ ScanPage
- ะกะฟะธัะพะบ ะฐะบัะธะฒะฝัั ัะตััะธะน ะฟะพะปัะทะพะฒะฐัะตะปั (ะตัะปะธ ะตััั)
- ะะฒะพัะฐ (ะฑะตัะฟะปะฐัะฝัั ะพััะฐะปะพัั / ะพะฟะปะฐัะตะฝะฝัั)

#### 4.2 ScanPage โ ะคะพัะพ + OCR
- ะะฝะพะฟะบะฐ ะทะฐะณััะทะบะธ ัะพัะพ (ะบะฐะผะตัะฐ ะธะปะธ ะณะฐะปะตัะตั)
- ะัะตะฒัั ะทะฐะณััะถะตะฝะฝัั ัะพัะพ (ะผะพะถะฝะพ ัะดะฐะปะธัั)
- ะะฝะพะฟะบะฐ "ะะฐัะฟะพะทะฝะฐัั" โ ะฟะพะบะฐะท ัะฟะธะฝะฝะตัะฐ โ ัะตะทัะปััะฐั
- ะะตะทัะปััะฐั OCR: ัะฟะธัะพะบ ะฟะพะทะธัะธะน ั ัะตะฝะฐะผะธ
- ะัะตะดัะฟัะตะถะดะตะฝะธะต ะฟัะธ mismatch ััะผะผั
- CTA: "ะัั ะฒะตัะฝะพ" / "ะะตะดะฐะบัะธัะพะฒะฐัั"

#### 4.3 EditItemsPage โ ะะตะดะฐะบัะธัะพะฒะฐะฝะธะต ะฟะพะทะธัะธะน
- ะกะฟะธัะพะบ ะฟะพะทะธัะธะน โ inline-edit (ัะฐะฟ โ ะผะตะฝัะตัั ัะตะบัั/ัะตะฝั)
- ะกะฒะฐะนะฟ ะฒะปะตะฒะพ โ ัะดะฐะปะธัั
- ะะฝะพะฟะบะฐ "+" โ ะดะพะฑะฐะฒะธัั ะฟะพะทะธัะธั
- ะัะพะณะพ ะฒะฝะธะทั (ะฟะตัะตััะธััะฒะฐะตััั ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ)
- CTA: "ะะฐัะฐัั ะณะพะปะพัะพะฒะฐะฝะธะต" โ ะณะตะฝะตัะธััะตั QR + invite link

#### 4.4 JoinPage โ ะัะธัะพะตะดะธะฝะตะฝะธะต
- ะัะธ ะพัะบัััะธะธ Mini App ะฟะพ deep link ั invite_code
- ะะพะบะฐะทัะฒะฐะตั: ะฝะฐะทะฒะฐะฝะธะต ัะตััะธะธ, ะฐะดะผะธะฝ, ะบะพะปะธัะตััะฒะพ ััะฐััะฝะธะบะพะฒ
- ะะฝะพะฟะบะฐ "ะัะธัะพะตะดะธะฝะธัััั" โ redirect ะฝะฐ VotingPage

#### 4.5 VotingPage โ ะะพะปะพัะพะฒะฐะฝะธะต (ะบะปััะตะฒะพะน ัะบัะฐะฝ)
- ะัะต ะฟะพะทะธัะธะธ ะฒะธะดะฝั (scroll, ะฝะต ะฟะฐะณะธะฝะฐัะธั!)
- ะะฐะถะดะฐั ะฟะพะทะธัะธั โ ะบะฐััะพัะบะฐ:
  - ะะฐะทะฒะฐะฝะธะต, ัะตะฝะฐ, ะบะพะปะธัะตััะฒะพ
  - ะะฝะพะฟะบะฐ +/- ะดะปั quantity (cycle: 0โ1โ2โ...โ0)
  - ะะฒะฐัะฐัั/ัะธัะบะธ ัะตั, ะบัะพ ัะถะต ะพัะผะตัะธะป
  - Real-time ะพะฑะฝะพะฒะปะตะฝะธะต ัะตัะตะท WebSocket
- ะะฝะธะทั: "ะขะฒะพะน ัะตะบััะธะน ะธัะพะณ: 1250โฝ"
- CTA: MainButton "ะะฐะปะตะต โ ะงะฐะตะฒัะต"
- Haptic feedback ะฟัะธ ะณะพะปะพัะพะฒะฐะฝะธะธ

#### 4.6 TipPage โ ะงะฐะตะฒัะต + ะปะธัะฝะฐั ัะฒะพะดะบะฐ
- ะกะปะฐะนะดะตั: 0%โ25% (ั preset-ะทะฝะฐัะตะฝะธัะผะธ 0, 5, 10, 15)
- ะะฐะทะฑะธะฒะบะฐ:
  - ะกะฟะธัะพะบ ะฒัะฑัะฐะฝะฝัั ะฑะปัะด ั ัะตะฝะฐะผะธ
  - ะะพะดะธัะพะณ
  - ะงะฐะตะฒัะต (X%)
  - **ะัะพะณะพ: Yโฝ**
- CTA: MainButton "ะะพะดัะฒะตัะดะธัั"

#### 4.7 SettlePage โ ะคะธะฝะฐะปัะฝัะน ัะฐัััั (ะดะปั ะฐะดะผะธะฝะฐ)
- ะัะพะณัะตัั: "ะะพะดัะฒะตัะดะธะปะธ: 3/5" ั ะฐะฒะฐัะฐัะฐะผะธ
- ะขะฐะฑะปะธัะฐ ะดะพะปะตะน: ะธะผั โ ััะผะผะฐ
- ะกะฟะธัะพะบ ะฝะตะพัะผะตัะตะฝะฝัั ะฟะพะทะธัะธะน (ะตัะปะธ ะตััั):
  - ะะฟัะธะธ: ัะฐะทะดะตะปะธัั ะฟะพัะพะฒะฝั / ัะฑัะฐัั ะธะท ััััะฐ / ะฒะตัะฝััั ะณะพะปะพัะพะฒะฐะฝะธะต
- CTA: "ะะฐะฒะตััะธัั ะธ ะพัะฟัะฐะฒะธัั ะธัะพะณะธ"

**ะะตะทัะปััะฐั:** ะะพะปะฝะพัััั ััะฝะบัะธะพะฝะฐะปัะฝัะน Mini App.

---

### ะญัะฐะฟ 5: ะะฝัะตะณัะฐัะธั ั ะฑะพัะพะผ

**ะฆะตะปั:** ะะพั ะพัะบััะฒะฐะตั Mini App, ะพัะฟัะฐะฒะปัะตั ัะฒะตะดะพะผะปะตะฝะธั, ะพะฑัะฐะฑะฐััะฒะฐะตั ะฟะปะฐัะตะถะธ.

**ะะฐะดะฐัะธ:**

1. **ะะฑะฝะพะฒะธัั `/start`**
   - ะะตะท deep link: ะฟะพะบะฐะทะฐัั ะบะฝะพะฟะบั `WebAppInfo(url="https://app.example.com/")`
   - ะก deep link (`/start {code}`): ะพัะบัััั Mini App ั `?startapp={code}`

2. **ะะฑะฝะพะฒะธัั QR/invite ะณะตะฝะตัะฐัะธั**
   - ะกััะปะบะฐ: `https://t.me/botname/appname?startapp={invite_code}`
   - QR-ะบะพะด ัะบะฐะทัะฒะฐะตั ะฝะฐ ััั ัััะปะบั

3. **Push-ัะฒะตะดะพะผะปะตะฝะธั ัะตัะตะท ะฑะพัะฐ**
   - API endpoint `POST /api/notify` (internal, bot โ API ะธะปะธ ะฝะฐะฟััะผัั)
   - ะัะธ ะทะฐะฒะตััะตะฝะธะธ ัะตััะธะธ: ะฑะพั ะพัะฟัะฐะฒะปัะตั ะบะฐะถะดะพะผั ััะฐััะฝะธะบั ัะพะพะฑัะตะฝะธะต ั ะธั ะดะพะปะตะน
   - ะัะธ ะฝะพะฒะพะผ ััะฐััะฝะธะบะต: ัะฒะตะดะพะผะปะตะฝะธะต ะฐะดะผะธะฝั

4. **Telegram Stars (ะพััะฐัััั ะฒ ะฑะพัะต)**
   - ะะพะบะฐ Telegram Stars API ะฝะตะดะพัััะฟะฝะพ ะฒ Mini App
   - ะัะธ ะฝะตัะฒะฐัะบะต ะบะฒะพัั: Mini App ะฟะพะบะฐะทัะฒะฐะตั "ะะฟะปะฐัะธัะต ะฒ ะฑะพัะต" ั ะบะฝะพะฟะบะพะน โ ะฟะตัะตัะพะด ะฒ ัะฐั ะฑะพัะฐ
   - ะะพั ะพะฑัะฐะฑะฐััะฒะฐะตั ะพะฟะปะฐัั, ะฟะธัะตั ะฒ ะะ
   - Mini App ะฟัะธ ัะปะตะดัััะตะผ ะทะฐะฟัะพัะต ะฒะธะดะธั ะพะฑะฝะพะฒะปัะฝะฝัั ะบะฒะพัั

5. **BotFather ะฝะฐัััะพะนะบะฐ**
   - `/setmenubutton` โ URL Mini App
   - ะะปะธ inline-ะบะฝะพะฟะบะฐ `WebAppInfo` ะฒ ะพัะฒะตัะต ะฝะฐ `/start`

**ะะตะทัะปััะฐั:** ะะพั ะธ Mini App ัะฐะฑะพัะฐัั ะบะฐะบ ะตะดะธะฝะพะต ัะตะปะพะต.

---

### ะญัะฐะฟ 6: ะะฟัะธะผะธะทะฐัะธั ะธ ะฟะพะปะธัะพะฒะบะฐ

1. **Offline/slow network**
   - Optimistic updates ะดะปั ะณะพะปะพัะพะฒะฐะฝะธั (UI ะพะฑะฝะพะฒะปัะตััั ะผะณะฝะพะฒะตะฝะฝะพ, ัะธะฝะบ ั ัะตัะฒะตัะพะผ async)
   - Skeleton loading states
   - Error boundaries + retry

2. **ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั**
   - Lazy loading ัะบัะฐะฝะพะฒ (React.lazy + Suspense)
   - ะะตะผะพะธะทะฐัะธั ะบะพะผะฟะพะฝะตะฝัะพะฒ (React.memo ะดะปั ItemCard)
   - Debounce ะดะปั ัะปะฐะนะดะตัะฐ ัะฐะตะฒัั

3. **UX polish**
   - Haptic feedback: `impactOccurred('light')` ะฟัะธ ะณะพะปะพัะพะฒะฐะฝะธะธ, `notificationOccurred('success')` ะฟัะธ ะฟะพะดัะฒะตัะถะดะตะฝะธะธ
   - Smooth ะฐะฝะธะผะฐัะธะธ (Framer Motion ะธะปะธ CSS transitions)
   - Pull-to-refresh ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั ะดะฐะฝะฝัั
   - Telegram theme: ะฟะพะดะดะตัะถะบะฐ light/dark mode
   - ะะดะฐะฟัะฐัะธั ะฟะพะด ัะฐะทะผะตั ััััะพะนััะฒะฐ (compact/expanded Mini App)

4. **ะะตะทะพะฟะฐัะฝะพััั**
   - Rate limiting ะฝะฐ API ัะฝะดะฟะพะธะฝัะฐั
   - ะะฐะปะธะดะฐัะธั ะฟัะฐะฒ: ัะพะปัะบะพ ะฐะดะผะธะฝ ะผะพะถะตั finish/settle/edit items
   - Sanitization: XSS-ะทะฐัะธัะฐ ะฒ ะฝะฐะทะฒะฐะฝะธัั ะฟะพะทะธัะธะน (ะธะท OCR)
   - CORS: ัะพะปัะบะพ ะดะพะผะตะฝ Mini App

5. **ะะพะฝะธัะพัะธะฝะณ**
   - ะะพะณะธัะพะฒะฐะฝะธะต API ะทะฐะฟัะพัะพะฒ
   - Sentry ะดะปั frontend ะพัะธะฑะพะบ
   - Health check endpoint

---

## ะะทะผะตะฝะตะฝะธั ะฒ pyproject.toml

```toml
[project]
dependencies = [
    # Existing
    "aiogram[i18n]>=3.15,<4",
    "sqlalchemy[asyncio]>=2.0,<3",
    "asyncpg>=0.30,<1",
    "alembic>=1.14,<2",
    "httpx>=0.28,<1",
    "pydantic>=2.0,<3",
    "pydantic-settings>=2.0,<3",
    "qrcode[pil]>=8.0,<9",
    # New for Mini App API
    "fastapi>=0.115,<1",
    "uvicorn[standard]>=0.34,<1",
    "python-multipart>=0.0.20,<1",
]
```

---

## ะะทะผะตะฝะตะฝะธั ะฒ docker-compose.yml

```yaml
services:
  bot:
    build: .
    command: python -m bot
    env_file: .env
    depends_on:
      db:
        condition: service_healthy

  api:
    build: .
    command: uvicorn api.app:create_app --factory --host 0.0.0.0 --port 8000
    env_file: .env
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy

  db:
    image: postgres:17-alpine
    # ... existing config
```

---

## ะะทะผะตะฝะตะฝะธั ะฒ .env

```env
# Existing
BOT_TOKEN=...
OPENROUTER_API_KEY=...
DATABASE_URL=...

# New
WEBAPP_URL=https://your-miniapp.vercel.app
WEBAPP_SECRET=<generated>  # ะดะปั ะดะพะฟะพะปะฝะธัะตะปัะฝัั internal API ะฒัะทะพะฒะพะฒ
```

---

## ะัะตะฝะบะฐ ัััะดะพะทะฐััะฐั

| ะญัะฐะฟ | ะะฟะธัะฐะฝะธะต | ะัะตะฝะบะฐ |
|------|----------|--------|
| 1 | Backend API + Auth | 2-3 ะดะฝั |
| 2 | WebSocket real-time | 1 ะดะตะฝั |
| 3 | Frontend ัะบะตะปะตั | 2 ะดะฝั |
| 4 | Frontend ัะบัะฐะฝั | 4-5 ะดะฝะตะน |
| 5 | ะะฝัะตะณัะฐัะธั ั ะฑะพัะพะผ | 1 ะดะตะฝั |
| 6 | ะะพะปะธัะพะฒะบะฐ | 2-3 ะดะฝั |
| **ะัะพะณะพ** | | **12-15 ะดะฝะตะน** |

---

## ะะธะณัะฐัะธั ะดะฐะฝะฝัั

ะะต ะฝัะถะฝะฐ. ะขะฐ ะถะต ะะ, ัะต ะถะต ัะฐะฑะปะธัั, ัะต ะถะต ะผะธะณัะฐัะธะธ. ะะพะฒัะน API-ัะปะพะน ัะธัะฐะตั ะธ ะฟะธัะตั ะฒ ัะต ะถะต ะผะพะดะตะปะธ.

---

## ะะธัะบะธ ะธ ัะตัะตะฝะธั

| ะะธัะบ | ะะตัะตะฝะธะต |
|------|---------|
| Telegram Stars ะฝะต ัะฐะฑะพัะฐะตั ะฒ Mini App | ะััะฐะฒะปัะตะผ ะพะฟะปะฐัั ะฒ ะฑะพัะต, Mini App ะฟะตัะตะฝะฐะฟัะฐะฒะปัะตั |
| WebSocket ัะตััะตั ัะพะตะดะธะฝะตะฝะธะต | Auto-reconnect + fallback ะฝะฐ polling (refetch TanStack Query) |
| initData expiration (24h) | ะัะธ 401 โ ะฟะพะบะฐะทะฐัั "ะะตัะตะพัะบัะพะนัะต ะฟัะธะปะพะถะตะฝะธะต" |
| ะะฐะณััะทะบะฐ ัะพัะพ: ัะฐะทะผะตั ัะฐะนะปะพะฒ | ะะตัะฐะนะท ะฝะฐ ะบะปะธะตะฝัะต ะฟะตัะตะด upload (canvas โ blob), ะปะธะผะธั 5MB |
| SEO/sharing | ะะต ะฐะบััะฐะปัะฝะพ โ Mini App ะพัะบััะฒะฐะตััั ัะพะปัะบะพ ะธะท Telegram |
| ะกัะฐััะต ะฟะพะปัะทะพะฒะฐัะตะปะธ ะฟัะธะฒัะบะปะธ ะบ ะฑะพัั | ะะฐัะฐะปะปะตะปัะฝะฐั ัะฐะฑะพัะฐ: ะฑะพั ะฒัั ะตัั ะฟัะธะฝะธะผะฐะตั ัะพัะพ ะธ ะบะพะผะฐะฝะดั |

---

## ะัะพะณะพ

ะะตัะตัะพะด ะฝะฐ Mini App:
- **ะะตัะตะธัะฟะพะปัะทัะตะผ 100% ะฑะธะทะฝะตั-ะปะพะณะธะบะธ** (services, models, calculator, OCR)
- **ะะธัะตะผ ะทะฐะฝะพะฒะพ**: API-ัะปะพะน (~15% ะบะพะดะฐ) + Frontend (~60% ััะธะปะธะน)
- **ะะพั ะพััะฐัััั**: ะดะปั /start, ัะฒะตะดะพะผะปะตะฝะธะน, ะพะฟะปะฐัั Stars
- **ะกััะฐัะตะณะธั**: ะฟะพััะฐะฟะฝะฐั ะผะธะณัะฐัะธั, ะฑะพั ะธ Mini App ัะฐะฑะพัะฐัั ะฟะฐัะฐะปะปะตะปัะฝะพ
