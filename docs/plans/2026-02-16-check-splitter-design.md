# Telegram Check Splitter ‚Äî Design Document

## Overview

Telegram-–±–æ—Ç –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å—á—ë—Ç–∞ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ. –ê–¥–º–∏–Ω —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–µ—Ç —á–µ–∫, –±–æ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç –ø–æ–∑–∏—Ü–∏–∏ —á–µ—Ä–µ–∑ LLM, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É/QR-–∫–æ–¥ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤. –£—á–∞—Å—Ç–Ω–∏–∫–∏ –æ—Ç–º–µ—á–∞—é—Ç —Å–≤–æ–∏ –±–ª—é–¥–∞, –±–æ—Ç —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–æ–ª—é –∫–∞–∂–¥–æ–≥–æ —Å —É—á—ë—Ç–æ–º —á–∞–µ–≤—ã—Ö.

## Tech Stack

- **Python 3.12** + **aiogram 3.x** (async, FSM, long polling)
- **SQLAlchemy 2.x** (async) + **Alembic** (–º–∏–≥—Ä–∞—Ü–∏–∏)
- **PostgreSQL**
- **OpenRouter API** ‚Äî –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫ LLM —Å vision (Claude, GPT-4o, Gemini –∏ –¥—Ä.), –º–æ–¥–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥
- **Docker Compose** (app + postgres)

## Architecture

Monolith + long polling. –û–¥–∏–Ω Python-–ø—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç Telegram –∏ –≤—ã–∑—ã–≤–∞–µ—Ç OpenRouter API –¥–ª—è OCR.

–í–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω—ã—Ö Telegram-–≥—Ä—É–ø–ø ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –≤–Ω—É—Ç—Ä–∏ –±–æ—Ç–∞. –ö–∞–∂–¥—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –æ–±—â–∞–µ—Ç—Å—è —Å –±–æ—Ç–æ–º –≤ –ª–∏—á–∫–µ, –±–æ—Ç —Å–≤—è–∑—ã–≤–∞–µ—Ç –∏—Ö —á–µ—Ä–µ–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å–µ—Å—Å–∏—é. QR-–∫–æ–¥/—Å—Å—ã–ª–∫–∞ –≤–µ–¥—ë—Ç –Ω–∞ deep link –±–æ—Ç–∞ (`t.me/bot?start=<invite_code>`).

### Project Structure

```
tg-check-splitter/
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îú‚îÄ‚îÄ __main__.py          # —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ start.py         # /start, deep link join session
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ check.py         # –ø–æ–ª—É—á–µ–Ω–∏–µ —Ñ–æ—Ç–æ, –∑–∞–ø—É—Å–∫ OCR
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ voting.py        # inline-–∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –±–ª—é–¥
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin.py         # —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–µ–π, —á–∞–µ–≤—ã–µ, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ocr.py           # –≤—ã–∑–æ–≤ OpenRouter API –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —á–µ–∫–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session.py       # –ª–æ–≥–∏–∫–∞ —Å–µ—Å—Å–∏–π
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ calculator.py    # —Ä–∞—Å—á—ë—Ç –¥–æ–ª–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ models/              # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ keyboards/           # inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îî‚îÄ‚îÄ config.py            # –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ env
‚îú‚îÄ‚îÄ alembic/
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ pyproject.toml
‚îî‚îÄ‚îÄ .env.example
```

## Data Model

### Session
| Field | Type | Description |
|-------|------|-------------|
| id | UUID PK | |
| admin_tg_id | BIGINT | Telegram ID —Å–æ–∑–¥–∞—Ç–µ–ª—è |
| invite_code | VARCHAR UNIQUE | –ö–æ–¥ –¥–ª—è deep link |
| status | ENUM | `created` ‚Üí `pending_payment` ‚Üí `pending_ocr` ‚Üí `voting` ‚Üí `calculating` ‚Üí `settled` ‚Üí `closed` |
| tip_percent | INT | –ü—Ä–æ—Ü–µ–Ω—Ç —á–∞–µ–≤—ã—Ö (default 0) |
| created_at | TIMESTAMP | |
| closed_at | TIMESTAMP NULL | |

### SessionPhoto
| Field | Type | Description |
|-------|------|-------------|
| id | UUID PK | |
| session_id | FK ‚Üí Session | |
| tg_file_id | VARCHAR | Telegram file_id —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ |
| created_at | TIMESTAMP | |

### SessionItem
| Field | Type | Description |
|-------|------|-------------|
| id | UUID PK | |
| session_id | FK ‚Üí Session | |
| name | VARCHAR | –ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ |
| price | DECIMAL | –¶–µ–Ω–∞ |
| quantity | INT | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (default 1) |

### SessionMember
| Field | Type | Description |
|-------|------|-------------|
| id | UUID PK | |
| session_id | FK ‚Üí Session | |
| user_tg_id | BIGINT | |
| display_name | VARCHAR | –ò–º—è –≤ Telegram |
| joined_at | TIMESTAMP | |

### ItemVote
| Field | Type | Description |
|-------|------|-------------|
| id | UUID PK | |
| item_id | FK ‚Üí SessionItem | |
| user_tg_id | BIGINT | |
| created_at | TIMESTAMP | |

Many-to-many: –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –º–æ–≥—É—Ç –æ—Ç–º–µ—Ç–∏—Ç—å –æ–¥–Ω–æ –±–ª—é–¥–æ, —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–µ–ª–∏—Ç—Å—è –ø–æ—Ä–æ–≤–Ω—É.

### UserQuota
| Field | Type | Description |
|-------|------|-------------|
| user_tg_id | BIGINT PK | |
| free_scans_used | INT | –ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ |
| quota_reset_at | TIMESTAMP | –ö–æ–≥–¥–∞ —Å–±—Ä–æ—Å–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ |

### Payment
| Field | Type | Description |
|-------|------|-------------|
| id | UUID PK | |
| user_tg_id | BIGINT | |
| session_id | FK ‚Üí Session | |
| stars_amount | INT | |
| telegram_charge_id | VARCHAR | |
| created_at | TIMESTAMP | |

## User Flow

### Admin (—Å–æ–∑–¥–∞—Ç–µ–ª—å —Å–µ—Å—Å–∏–∏)

1. `/start` ‚Üí –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ —á–µ–∫–∞ (–æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ)
   - –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ñ–æ—Ç–æ: "–§–æ—Ç–æ N –ø—Ä–∏–Ω—è—Ç–æ. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—â—ë –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ: [üì∏ –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å]"
   - –í—Å–µ —Ñ–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ LLM –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
3. –ï—Å–ª–∏ –ª–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω ‚Üí "–û–ø–ª–∞—Ç–∏—Ç–µ X Stars" ‚Üí –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Telegram Stars
4. OCR ‚Üí –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ + –∫–Ω–æ–ø–∫–∏:
   - `[‚úÖ –í—Å—ë –≤–µ—Ä–Ω–æ]` `[‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å]` `[üîÑ –ü–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ]`
   - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ/—Ü–µ–Ω—É, –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é, —É–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é
5. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí –±–æ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç QR-–∫–æ–¥ + —Å—Å—ã–ª–∫—É
6. –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è ‚Üí "–ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏: 3/5 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
   - `[üìä –¢–µ–∫—É—â–∏–π —Ä–∞—Å—á—ë—Ç]` `[‚èπ –ó–∞–≤–µ—Ä—à–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ]`
7. –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏:
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –Ω–µ–æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö
   - `[üîÑ –í–µ—Ä–Ω—É—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ]` `[‚ûó –†–∞–∑–¥–µ–ª–∏—Ç—å –ø–æ—Ä–æ–≤–Ω—É]` `[üóë –£–±—Ä–∞—Ç—å –∏–∑ —Å—á—ë—Ç–∞]`
8. –ó–∞–¥–∞—Ç—å % —á–∞–µ–≤—ã—Ö (0/5/10/15/–¥—Ä—É–≥–æ–π)
9. –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ ‚Üí `[‚úÖ –í—Å–µ —Ä–∞—Å—Å—á–∏—Ç–∞–ª–∏—Å—å]` ‚Üí —Å–µ—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞

### Participant (–ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è –ø–æ QR/—Å—Å—ã–ª–∫–µ)

1. –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ `t.me/bot?start=<invite_code>` ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π join
2. –°–ø–∏—Å–æ–∫ –±–ª—é–¥ —Å inline-–∫–Ω–æ–ø–∫–∞–º–∏ (–ø–∞–≥–∏–Ω–∞—Ü–∏—è –ø–æ 8 –ø—Ä–∏ >8 –ø–æ–∑–∏—Ü–∏–π)
   - –ù–∞–∂–∞–ª = –æ—Ç–º–µ—Ç–∏–ª, –Ω–∞–∂–∞–ª –ø–æ–≤—Ç–æ—Ä–Ω–æ = —É–±—Ä–∞–ª
   - –í–∏–¥–Ω–æ –∫—Ç–æ –µ—â—ë –æ—Ç–º–µ—Ç–∏–ª –∫–∞–∂–¥–æ–µ –±–ª—é–¥–æ
   - `[‚ö†Ô∏è –ù–µ –≤–∏–∂—É —Å–≤–æ—ë –±–ª—é–¥–æ]` ‚Üí —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
3. `[‚úÖ –ì–æ—Ç–æ–≤–æ]` ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞
4. –ü–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–π –∏—Ç–æ–≥: "–¢–≤–æ—è –¥–æ–ª—è: 825‚ÇΩ (–≤–∫–ª—é—á–∞—è 10% —á–∞–µ–≤—ã—Ö)"

## OCR via OpenRouter

–§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ LLM —Å –ø—Ä–æ–º–ø—Ç–æ–º, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON:

```json
{
  "items": [
    {"name": "–ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞", "price": 650, "quantity": 1},
    {"name": "–¢–æ–º –Ø–º", "price": 450, "quantity": 2}
  ],
  "total": 1550,
  "currency": "RUB"
}
```

–î–ª—è –º—É–ª—å—Ç–∏-—Ñ–æ—Ç–æ: –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ, –ø—Ä–æ–º–ø—Ç —É–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –∏ –∏—Å–∫–ª—é—á–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã.

**–í–∞–ª–∏–¥–∞—Ü–∏—è:** —Å—É–º–º–∞ –ø–æ–∑–∏—Ü–∏–π —Å–≤–µ—Ä—è–µ—Ç—Å—è —Å `total`. –ü—Ä–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–∏ >5% ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É.

## Calculation Logic

```
–î–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞:
  –¥–æ–ª—è = Œ£ (—Ü–µ–Ω–∞_–±–ª—é–¥–∞ / –∫–æ–ª-–≤–æ_–ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–≤—à–∏—Ö)
  –¥–æ–ª—è_—Å_—á–∞–µ–≤—ã–º–∏ = –¥–æ–ª—è √ó (1 + tip_percent / 100)
  –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ —Ü–µ–ª–æ–≥–æ –≤–≤–µ—Ä—Ö
```

## Monetization

Freemium —á–µ—Ä–µ–∑ Telegram Stars:
- N –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ –º–µ—Å—è—Ü
- –ü–æ—Å–ª–µ –ª–∏–º–∏—Ç–∞ ‚Äî –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Telegram Stars –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º OCR
- Stars –º–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ —á–µ—Ä–µ–∑ Fragment
